{% extends "base.html" %}

{% block title %}Deal Insights Dashboard - AI Investment Platform{% endblock %}
{% block main_class %}min-h-screen bg-gradient-to-br from-slate-50 via-gray-50 to-blue-50 dark:from-slate-900 dark:via-gray-900 dark:to-slate-800 transition-colors duration-300{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<!-- Chart.js Plugins -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient@0.0.4/dist/chartjs-plugin-gradient.min.js"></script>

<style>
    .swipe-card {
        transform-origin: center center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
    }
    
    .swipe-card.swiping {
        transition: none;
    }
    
    .swipe-card.swiped-right {
        transform: translateX(100vw) rotate(15deg);
        opacity: 0;
    }
    
    .swipe-card.swiped-left {
        transform: translateX(-100vw) rotate(-15deg);
        opacity: 0;
    }
    
    .professional-gradient {
        background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
    }
    
    .dark .professional-gradient {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    }
    
    .accent-gradient {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    }
    
    .success-gradient {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }
    
    .warning-gradient {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    }
    
    .card-shadow {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
    }
    
    .dark .card-shadow {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    .metric-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .dark .metric-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .action-button {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
    }
    
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
    }

    /* Professional Chart Cards with Glass Morphism */
    .professional-chart-card {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(248, 250, 252, 0.92));
        border: 1px solid rgba(148, 163, 184, 0.18);
        backdrop-filter: blur(18px);
        border-radius: 20px;
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        contain: layout style paint;
    }

    .dark .professional-chart-card {
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.92), rgba(15, 23, 42, 0.88));
        border: 1px solid rgba(148, 163, 184, 0.12);
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .professional-chart-card:hover {
        transform: translateY(-8px) scale(1.01);
        box-shadow: 
            0 15px 40px rgba(0, 0, 0, 0.15),
            0 0 0 1px rgba(59, 130, 246, 0.1);
    }

    .chart-header-pro {
        padding: 2rem 2rem 1.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.06), rgba(14, 165, 233, 0.05));
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chart-title-section {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chart-icon {
        width: 52px;
        height: 52px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
    }

    .chart-icon:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
        line-height: 1.2;
    }

    .dark .chart-title {
        color: #f8fafc;
    }

    .chart-subtitle {
        color: #64748b;
        font-size: 0.875rem;
        margin: 0.25rem 0 0;
        font-weight: 500;
    }

    .dark .chart-subtitle {
        color: #94a3b8;
    }

    .chart-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chart-action-btn {
        width: 36px;
        height: 36px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #3b82f6;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .chart-action-btn:hover {
        background: #3b82f6;
        color: white;
        transform: scale(1.1);
    }

    .chart-body-pro {
        padding: 1.5rem;
        height: 450px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .chart-container {
        position: relative;
        height: 100%;
        width: 100%;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
    }

    @media (max-width: 1200px) {
        .charts-grid {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .chart-body-pro {
            height: 350px;
            padding: 1rem;
        }
        
        .chart-header-pro {
            padding: 1.5rem 1.5rem 1rem;
        }
    }
    
    .action-button:active {
        transform: translateY(0);
    }
    
    .score-badge {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 1px solid #cbd5e1;
    }
    
    .dark .score-badge {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 1px solid #475569;
    }
    
    .match-indicator {
        position: relative;
        overflow: hidden;
    }
    
    .match-indicator::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }
    
    .match-indicator:hover::before {
        left: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Professional Header Section -->
<div class="relative z-10">
    <div class="max-w-6xl mx-auto px-6 py-12">
        <!-- Top Navigation Bar -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 accent-gradient rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Deal Insights</h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400">AI-Powered Investment Discovery</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="rerankBtn" class="accent-gradient text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:shadow-lg action-button">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh Matches
                </button>
                <button id="viewAllBtn" class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg font-medium border border-gray-200 dark:border-gray-600 hover:border-blue-500 transition-all duration-200 action-button">
                    <i class="fas fa-list mr-2"></i>
                    List View
                </button>
            </div>
        </div>
        
        <!-- Main Title Section -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-16 h-16 professional-gradient rounded-2xl mb-6">
                <i class="fas fa-briefcase text-white text-2xl"></i>
            </div>
            <h2 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">Investment Opportunities</h2>
            <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto leading-relaxed">
                Discover and evaluate startup investment opportunities through our AI-powered matching system. 
                Swipe through personalized recommendations based on your investment criteria.
            </p>
        </div>
    </div>

    <!-- Portfolio Analytics -->
    {% if recommendations %}
    <div class="max-w-6xl mx-auto px-6 mb-12">
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Portfolio Match Analysis</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400">AI-calculated compatibility scores based on your investment preferences</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="metric-card rounded-xl p-6 text-center card-shadow">
                <div class="w-14 h-14 success-gradient rounded-xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check-circle text-white text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1">{{ recommendations.summary.high_match_count or 0 }}</h3>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">High Compatibility</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">80%+ match score</p>
            </div>
            <div class="metric-card rounded-xl p-6 text-center card-shadow">
                <div class="w-14 h-14 warning-gradient rounded-xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1">{{ recommendations.summary.medium_match_count or 0 }}</h3>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Medium Compatibility</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">50-79% match score</p>
            </div>
            <div class="metric-card rounded-xl p-6 text-center card-shadow">
                <div class="w-14 h-14 accent-gradient rounded-xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-info-circle text-white text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1">{{ recommendations.summary.low_match_count or 0 }}</h3>
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Low Compatibility</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Below 50% match score</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Investment Opportunity Cards -->
    <div class="max-w-lg mx-auto px-6 mb-12">
        <div class="mb-6 text-center">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Investment Opportunities</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400">Swipe to evaluate opportunities or use action buttons below</p>
        </div>
        
        <div id="cardStack" class="relative h-[500px]">
            {% if startup_reports %}
                {% for report in startup_reports %}
                {% set submission = report.submission or {} %}
                {% set company_profile = report.companyProfile or {} %}
                {% set scores = report.scores or {} %}
                {% set ai_insights = report.aiInsights or {} %}
                {% set startup_id = report.startup_id or 'unknown' %}
                
                <!-- Find ranking for this startup -->
                {% set ranking = None %}
                {% set match_score = None %}
                {% set reasoning = None %}
                {% if recommendations and recommendations.rankings %}
                    {% for rank in recommendations.rankings %}
                        {% if rank.startup_id == startup_id %}
                            {% set ranking = rank.rank %}
                            {% set match_score = rank.match_score %}
                            {% set reasoning = rank.reasoning %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                
                <div class="swipe-card absolute inset-0 bg-white dark:bg-gray-800 rounded-2xl card-shadow cursor-grab active:cursor-grabbing border border-gray-200 dark:border-gray-700" 
                     data-startup-id="{{ startup_id }}" 
                     data-score="{{ scores.OverallScore or 0 }}" 
                     data-ranking="{{ ranking or 999 }}"
                     style="z-index: {{ loop.revindex }}; transform: scale({{ 1 - (loop.index0 * 0.03) }}) translateY({{ loop.index0 * 8 }}px);">
                    
                    <!-- Professional Header -->
                    <div class="relative h-32 professional-gradient rounded-t-2xl overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-b from-black/20 to-transparent"></div>
                        <div class="absolute top-4 right-4">
                            {% if ranking %}
                            <div class="score-badge rounded-lg px-3 py-1">
                                <span class="text-sm font-bold text-gray-800 dark:text-white">#{{ ranking }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="absolute bottom-4 left-4 right-4">
                            <h3 class="text-xl font-bold text-white mb-1">{{ submission.startupName or 'Unnamed Startup' }}</h3>
                            <p class="text-white/90 text-sm">{{ company_profile.sector or 'Sector pending' }}</p>
                        </div>
                    </div>
                    
                    <!-- Card Content -->
                    <div class="p-6">
                        <!-- Match Score & Overall Score -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-gray-900 dark:text-white">{{ scores.OverallScore or 0 }}/10</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Overall Score</div>
                            </div>
                            {% if match_score %}
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ match_score }}%</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Match Score</div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Key Investment Metrics -->
                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-lg font-bold text-blue-600 dark:text-blue-400">{{ scores.FounderMarketFit or 0 }}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Founder Fit</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-lg font-bold text-green-600 dark:text-green-400">{{ scores.Traction or 0 }}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Traction</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-lg font-bold text-purple-600 dark:text-purple-400">{{ scores.MarketPotential or 0 }}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Market</div>
                            </div>
                        </div>
                        
                        <!-- Company Description -->
                        <div class="mb-4">
                            <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed line-clamp-3">
                                {{ company_profile.description or 'No description available' }}
                            </p>
                        </div>
                        
                        <!-- AI Investment Reasoning -->
                        {% if reasoning %}
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 border border-blue-200 dark:border-blue-700 rounded-lg p-4 mb-4">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-blue-600 dark:bg-blue-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-brain text-white text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <p class="text-sm font-semibold text-blue-800 dark:text-blue-200">AI Investment Analysis</p>
                                        {% if match_score %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200">
                                            {{ match_score }}% Match
                                        </span>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm text-blue-700 dark:text-blue-300 leading-relaxed">{{ reasoning }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Investment Readiness Badge -->
                        <div class="flex items-center justify-center">
                            <span class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium 
                                {% if ai_insights.investmentReadiness == 'High' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                {% elif ai_insights.investmentReadiness == 'Medium' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                {% else %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% endif %}">
                                <i class="fas fa-chart-line mr-2"></i>
                                {{ ai_insights.investmentReadiness or 'Unknown' }} Investment Readiness
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="absolute inset-0 bg-white dark:bg-gray-800 rounded-2xl card-shadow flex items-center justify-center border border-gray-200 dark:border-gray-700">
                    <div class="text-center">
                        <div class="w-16 h-16 professional-gradient rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-search text-white text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Opportunities Found</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Refresh to discover new investment opportunities</p>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <!-- Professional Action Buttons -->
        <div class="flex justify-center space-x-6 mt-8">
            <button id="passBtn" class="action-button w-14 h-14 bg-white dark:bg-gray-800 rounded-xl shadow-lg flex items-center justify-center text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 border border-red-200 dark:border-red-800">
                <i class="fas fa-times text-xl"></i>
            </button>
            <button id="infoBtn" class="action-button w-14 h-14 bg-white dark:bg-gray-800 rounded-xl shadow-lg flex items-center justify-center text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
                <i class="fas fa-info text-xl"></i>
            </button>
            <button id="likeBtn" class="action-button w-14 h-14 bg-white dark:bg-gray-800 rounded-xl shadow-lg flex items-center justify-center text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 border border-green-200 dark:border-green-800">
                <i class="fas fa-check text-xl"></i>
            </button>
        </div>
        
        <!-- Professional Instructions -->
        <div class="text-center mt-6">
            <div class="flex items-center justify-center space-x-6 text-sm text-gray-600 dark:text-gray-400">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-times text-red-500"></i>
                    <span>Pass</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-info text-blue-500"></i>
                    <span>Details</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Interested</span>
                </div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">
                Swipe cards or use buttons to evaluate opportunities
            </p>
        </div>
    </div>
</div>

<script>
// Tinder-like swipe functionality
class SwipeCards {
    constructor() {
        this.cards = document.querySelectorAll('.swipe-card');
        this.currentCardIndex = 0;
        this.isAnimating = false;
        this.init();
    }
    
    init() {
        this.cards.forEach((card, index) => {
            if (index === 0) {
                card.style.zIndex = this.cards.length;
            }
            this.addSwipeListeners(card);
        });
        
        // Button listeners
        document.getElementById('passBtn').addEventListener('click', () => this.swipeCard('left'));
        document.getElementById('likeBtn').addEventListener('click', () => this.swipeCard('right'));
        document.getElementById('infoBtn').addEventListener('click', () => this.showDetails());
    }
    
    addSwipeListeners(card) {
        let startX, startY, currentX, currentY;
        let isDragging = false;
        
        card.addEventListener('mousedown', (e) => {
            startX = e.clientX;
            startY = e.clientY;
            isDragging = true;
            card.classList.add('swiping');
            e.preventDefault();
        });
        
        card.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            currentX = e.clientX;
            currentY = e.clientY;
            
            const deltaX = currentX - startX;
            const deltaY = currentY - startY;
            const rotation = deltaX * 0.1;
            
            card.style.transform = `translateX(${deltaX}px) translateY(${deltaY}px) rotate(${rotation}deg)`;
            
            // Change opacity based on swipe direction
            const opacity = Math.max(0.3, 1 - Math.abs(deltaX) / 300);
            card.style.opacity = opacity;
        });
        
        card.addEventListener('mouseup', () => {
            if (!isDragging) return;
            isDragging = false;
            card.classList.remove('swiping');
            
            const deltaX = currentX - startX;
            const threshold = 100;
            
            if (Math.abs(deltaX) > threshold) {
                if (deltaX > 0) {
                    this.swipeCard('right');
                } else {
                    this.swipeCard('left');
                }
            } else {
                // Snap back
                card.style.transform = '';
                card.style.opacity = '';
            }
        });
        
        // Touch events for mobile
        card.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isDragging = true;
            card.classList.add('swiping');
        });
        
        card.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY;
            
            const deltaX = currentX - startX;
            const deltaY = currentY - startY;
            const rotation = deltaX * 0.1;
            
            card.style.transform = `translateX(${deltaX}px) translateY(${deltaY}px) rotate(${rotation}deg)`;
            
            const opacity = Math.max(0.3, 1 - Math.abs(deltaX) / 300);
            card.style.opacity = opacity;
        });
        
        card.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            card.classList.remove('swiping');
            
            const deltaX = currentX - startX;
            const threshold = 100;
            
            if (Math.abs(deltaX) > threshold) {
                if (deltaX > 0) {
                    this.swipeCard('right');
                } else {
                    this.swipeCard('left');
                }
            } else {
                card.style.transform = '';
                card.style.opacity = '';
            }
        });
    }
    
    swipeCard(direction) {
        if (this.isAnimating || this.currentCardIndex >= this.cards.length) return;
        
        this.isAnimating = true;
        const currentCard = this.cards[this.currentCardIndex];
        
        if (direction === 'right') {
            currentCard.classList.add('swiped-right');
            this.updateInterest(currentCard.dataset.startupId, 'interested');
            showNotification('✓ Marked as Interested', 'success');
        } else {
            currentCard.classList.add('swiped-left');
            this.updateInterest(currentCard.dataset.startupId, 'not_interested');
            showNotification('✗ Passed on Opportunity', 'info');
        }
        
        setTimeout(() => {
            currentCard.style.display = 'none';
            this.currentCardIndex++;
            this.isAnimating = false;
            
            // Check if we need more cards
            if (this.currentCardIndex >= this.cards.length) {
                this.showNoMoreCards();
            }
        }, 300);
    }
    
    showDetails() {
        if (this.currentCardIndex >= this.cards.length) return;
        
        const currentCard = this.cards[this.currentCardIndex];
        const startupId = currentCard.dataset.startupId;
        window.location.href = `/investor/deal-insights/${startupId}`;
    }
    
    showNoMoreCards() {
        const cardStack = document.getElementById('cardStack');
        cardStack.innerHTML = `
            <div class="absolute inset-0 bg-white dark:bg-gray-800 rounded-3xl card-shadow flex items-center justify-center">
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-heart text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">No more matches!</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">Get new matches to continue swiping</p>
                    <button onclick="location.reload()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full font-semibold">
                        Get New Matches
                    </button>
                </div>
            </div>
        `;
    }
    
    async updateInterest(startupId, interestLevel) {
        try {
            const response = await fetch(`/investor/api/startup-interest/${startupId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ interest_level: interestLevel })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('Failed to update interest:', result.message);
            }
        } catch (error) {
            console.error('Error updating interest:', error);
        }
    }
}

// Initialize swipe functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new SwipeCards();
});

// Rerank button functionality
document.getElementById('rerankBtn').addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Getting New Matches...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/investor/api/rerank', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('✓ New opportunities available', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(result.message || 'Failed to refresh opportunities', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('An error occurred while getting new matches', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});

// View all button functionality
document.getElementById('viewAllBtn').addEventListener('click', () => {
    // Toggle between swipe view and list view
    const cardStack = document.getElementById('cardStack');
    const isListView = cardStack.classList.contains('list-view');
    
    if (isListView) {
        // Switch to swipe view
        location.reload();
    } else {
        // Switch to list view (you can implement this)
        showNotification('List view feature coming soon', 'info');
    }
});

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium shadow-lg transition-all duration-300 transform ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Add entrance animation
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
